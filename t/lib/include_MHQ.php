<?PHP
class MHQmethod extends method{

	public $step1 = [
		1=>['reflect'=>1,'erase'=>0],
		2=>['reflect'=>1,'erase'=>0],
		3=>['reflect'=>1,'erase'=>0],
		4=>['reflect'=>1,'erase'=>0],
		5=>['reflect'=>0,'erase'=>0],
		6=>['reflect'=>0,'erase'=>0],
		7=>['reflect'=>1,'erase'=>0],
		8=>['reflect'=>0,'erase'=>0],
		9=>['reflect'=>0,'erase'=>0],
		10=>['reflect'=>0,'erase'=>0],
		11=>['reflect'=>1,'erase'=>0],
		12=>['reflect'=>0,'erase'=>0],
		13=>['reflect'=>0,'erase'=>0],
		14=>['reflect'=>1,'erase'=>0],
		15=>['reflect'=>0,'erase'=>0],
		16=>['reflect'=>1,'erase'=>0],
		17=>['reflect'=>0,'erase'=>0],
		18=>['reflect'=>0,'erase'=>0],
		19=>['reflect'=>0,'erase'=>0],
		20=>['reflect'=>1,'erase'=>0],
		21=>['reflect'=>1,'erase'=>0],
		22=>['reflect'=>0,'erase'=>0],
		23=>['reflect'=>0,'erase'=>0],
		24=>['reflect'=>0,'erase'=>0],
		25=>['reflect'=>0,'erase'=>0],
		26=>['reflect'=>0,'erase'=>0],
		27=>['reflect'=>0,'erase'=>0],
		28=>['reflect'=>0,'erase'=>0],
		29=>['reflect'=>1,'erase'=>0],
		30=>['reflect'=>0,'erase'=>0],
		31=>['reflect'=>1,'erase'=>0],
		32=>['reflect'=>0,'erase'=>0],
		33=>['reflect'=>0,'erase'=>1],
		34=>['reflect'=>1,'erase'=>0],
		35=>['reflect'=>1,'erase'=>0],
		36=>['reflect'=>0,'erase'=>0],
		37=>['reflect'=>0,'erase'=>0],
		38=>['reflect'=>0,'erase'=>0],
		39=>['reflect'=>1,'erase'=>0],
		40=>['reflect'=>0,'erase'=>0],
		41=>['reflect'=>1,'erase'=>0],
		42=>['reflect'=>0,'erase'=>0],
		43=>['reflect'=>0,'erase'=>0],
		44=>['reflect'=>0,'erase'=>0],
		45=>['reflect'=>1,'erase'=>0],
		46=>['reflect'=>0,'erase'=>0],
		47=>['reflect'=>0,'erase'=>0],
		48=>['reflect'=>1,'erase'=>0],
		49=>['reflect'=>1,'erase'=>0],
		50=>['reflect'=>0,'erase'=>0],
		51=>['reflect'=>1,'erase'=>0],
		52=>['reflect'=>0,'erase'=>1],
		53=>['reflect'=>1,'erase'=>0],
		54=>['reflect'=>1,'erase'=>0],
		55=>['reflect'=>1,'erase'=>0],
		56=>['reflect'=>0,'erase'=>0],
		57=>['reflect'=>0,'erase'=>0],
		58=>['reflect'=>1,'erase'=>0],
		59=>['reflect'=>0,'erase'=>0],
		60=>['reflect'=>0,'erase'=>1],
		61=>['reflect'=>0,'erase'=>1],
		62=>['reflect'=>0,'erase'=>0],
		63=>['reflect'=>1,'erase'=>0],
		64=>['reflect'=>0,'erase'=>1],
		65=>['reflect'=>1,'erase'=>0],
		66=>['reflect'=>0,'erase'=>0],
		67=>['reflect'=>0,'erase'=>0],
		68=>['reflect'=>0,'erase'=>0],
		69=>['reflect'=>1,'erase'=>0],
		70=>['reflect'=>0,'erase'=>0],
		71=>['reflect'=>1,'erase'=>0],
		72=>['reflect'=>0,'erase'=>0],
		73=>['reflect'=>1,'erase'=>0],
		74=>['reflect'=>1,'erase'=>0],
		75=>['reflect'=>1,'erase'=>0],
		76=>['reflect'=>1,'erase'=>0],
		77=>['reflect'=>0,'erase'=>0],
		78=>['reflect'=>0,'erase'=>0],
		79=>['reflect'=>1,'erase'=>0],
		80=>['reflect'=>0,'erase'=>0],
		81=>['reflect'=>0,'erase'=>0],
		82=>['reflect'=>0,'erase'=>0],
		83=>['reflect'=>1,'erase'=>0],
		84=>['reflect'=>0,'erase'=>0],
		85=>['reflect'=>0,'erase'=>0],
		86=>['reflect'=>0,'erase'=>0],
		87=>['reflect'=>1,'erase'=>0],
		88=>['reflect'=>0,'erase'=>1],
		89=>['reflect'=>1,'erase'=>0],
		90=>['reflect'=>0,'erase'=>0],
		91=>['reflect'=>1,'erase'=>0],
		92=>['reflect'=>0,'erase'=>0],
		93=>['reflect'=>1,'erase'=>0],
		94=>['reflect'=>1,'erase'=>0],
		95=>['reflect'=>0,'erase'=>0],
		96=>['reflect'=>0,'erase'=>0],
		97=>['reflect'=>0,'erase'=>0],
		98=>['reflect'=>1,'erase'=>0],
		99=>['reflect'=>1,'erase'=>1],
		100=>['reflect'=>1,'erase'=>0],
		101=>['reflect'=>1,'erase'=>0],
		102=>['reflect'=>0,'erase'=>0],
		103=>['reflect'=>1,'erase'=>0],
		104=>['reflect'=>0,'erase'=>0],
		105=>['reflect'=>0,'erase'=>0],
		106=>['reflect'=>1,'erase'=>0],
		107=>['reflect'=>1,'erase'=>1],
		108=>['reflect'=>1,'erase'=>1],
		109=>['reflect'=>1,'erase'=>0],
		110=>['reflect'=>0,'erase'=>0],
		111=>['reflect'=>1,'erase'=>0],
		112=>['reflect'=>1,'erase'=>0],
		113=>['reflect'=>0,'erase'=>0],
		114=>['reflect'=>0,'erase'=>0],
		115=>['reflect'=>1,'erase'=>0],
		116=>['reflect'=>0,'erase'=>0],
		117=>['reflect'=>1,'erase'=>0],
		118=>['reflect'=>0,'erase'=>0],
		119=>['reflect'=>1,'erase'=>0],
		120=>['reflect'=>1,'erase'=>0],

	]; 

	public $step2 = [
		1=>[6,28,113],
		2=>[2,11,21,83],
		3=>[65],
		4=>[87],
		5=>[49],
		6=>[13,15,19,32,47,67,70,72,82],
		7=>[17,24,25,50,95,110],
		8=>[10,57,75,80,85,104],
		9=>[56,59,63,92,101],
		10=>[16,55,73,93,120],
		11=>[54,74,79,89],
		12=>[7,29,45,112,119],
		13=>[3,14,34,53,58,69,71,98,100],
		14=>[4,51,103,117],
		15=>[31,91,115],
		16=>[12,38,43,62],
		17=>[1,8,18,23,39,76,97],
		18=>[22,78,84,109,111,118],
		19=>[20,42,44,94,102,106],
		20=>[5,37,66,86,114,116],
		21=>[9,26,36,40,48,81],
		22=>[27,30,35,41,68,77,96],
		23=>[46,90,105],
	];

	public $step3 = [
		1=>[1,2,3,4,5],
		2=>[6,7],
		3=>[8,9],
		4=>[10,11,12,13,14,15],
		5=>[16],
		6=>[17,18,19],
		7=>[20,21],
	];

	public $hensa1 =[
		1=>['avg'=>-1.59707264,'hensa'=>0.922309454],
		2=>['avg'=>-4.621052632,'hensa'=>2.66609706],
		3=>['avg'=>-0.384688995,'hensa'=>1.774178164],
		4=>['avg'=>-2.436363636,'hensa'=>0.980683378],
		5=>['avg'=>-0.984688995,'hensa'=>0.162971873],
		6=>['avg'=>-0.638277512,'hensa'=>0.680042849],
		7=>['avg'=>-0.177033493,'hensa'=>0.916749408],
		8=>['avg'=>3.681339713,'hensa'=>4.390168019],
		9=>['avg'=>3.423923445,'hensa'=>3.170317164],
		10=>['avg'=>0.257416268,'hensa'=>2.281977449],
		11=>['avg'=>-4.064114833,'hensa'=>5.473791781],
		12=>['avg'=>-1.021052632,'hensa'=>4.156914669],
		13=>['avg'=>-3.043062201,'hensa'=>2.26034299],
		14=>['avg'=>-5.789473684,'hensa'=>4.764068485],
		15=>['avg'=>-2.563636364,'hensa'=>1.950835469],
		16=>['avg'=>-3.339712919,'hensa'=>1.180544807],
		17=>['avg'=>0.528229665,'hensa'=>1.629987297],
		18=>['avg'=>5.985645933,'hensa'=>2.968863087],
		19=>['avg'=>-3.477511962,'hensa'=>1.016006598],
		20=>['avg'=>-2.922488038,'hensa'=>0.427210302],
		21=>['avg'=>-3.271770335,'hensa'=>1.452540169],
		22=>['avg'=>-3.271770335,'hensa'=>1.452540169],
		23=>['avg'=>-0.624611769,'hensa'=>0.385243985],
		24=>['avg'=>-10.61913876,'hensa'=>4.850927719],
		25=>['avg'=>-4.898564593,'hensa'=>2.297335225],
		26=>['avg'=>-3.953110048,'hensa'=>2.254756247],
		27=>['avg'=>-1.767464115,'hensa'=>1.989564589],
		28=>['avg'=>-0.788516746,'hensa'=>2.89534558],
		29=>['avg'=>0.653588517,'hensa'=>2.310905919],
		30=>['avg'=>-1.442105263,'hensa'=>1.781281558],
		31=>['avg'=>-0.484621514,'hensa'=>-0.302543264],
		32=>['avg'=>-5.001913876,'hensa'=>2.142751478],
		33=>['avg'=>-0.623923445,'hensa'=>1.129509321],
	];
	public $hensa2 =[
		1=>['avg'=>-1.343375617,'hensa'=>1.243955082,],
		2=>['avg'=>-3.88372093,'hensa'=>3.822876686,],
		3=>['avg'=>-0.186046512,'hensa'=>1.728769073,],
		4=>['avg'=>-2.302325581,'hensa'=>2.118960734,],
		5=>['avg'=>-0.813953488,'hensa'=>0.494425387,],
		6=>['avg'=>-0.23255814,'hensa'=>0.772709197,],
		7=>['avg'=>-0.348837209,'hensa'=>0.774107766,],
		8=>['avg'=>-0.209302326,'hensa'=>4.944144479,],
		9=>['avg'=>0.279069767,'hensa'=>3.419000135,],
		10=>['avg'=>-0.488372093,'hensa'=>2.591328052,],
		11=>['avg'=>-2.093023256,'hensa'=>5.762000434,],
		12=>['avg'=>-0.674418605,'hensa'=>4.038886159,],
		13=>['avg'=>-1.418604651,'hensa'=>2.442192668,],
		14=>['avg'=>-5.953488372,'hensa'=>7.448906548,],
		15=>['avg'=>-1.511627907,'hensa'=>2.815010372,],
		16=>['avg'=>-2.558139535,'hensa'=>1.833820838,],
		17=>['avg'=>0.11627907,'hensa'=>1.955425396,],
		18=>['avg'=>2.069767442,'hensa'=>3.793478791,],
		19=>['avg'=>-1.953488372,'hensa'=>1.842060125,],
		20=>['avg'=>-2.11627907,'hensa'=>1.401150729,],
		21=>['avg'=>-2.209302326,'hensa'=>2.006479499,],
		22=>['avg'=>-2.209302326,'hensa'=>2.006479499,],
		23=>['avg'=>-0.459098327,'hensa'=>0.560018213,],
		24=>['avg'=>-5.813953488,'hensa'=>6.841242285,],
		25=>['avg'=>-3.023255814,'hensa'=>3.068886413,],
		26=>['avg'=>-1.348837209,'hensa'=>2.852039017,],
		27=>['avg'=>-1.441860465,'hensa'=>2.254734817,],
		28=>['avg'=>-1.837209302,'hensa'=>3.319640164,],
		29=>['avg'=>-0.674418605,'hensa'=>2.227950672,],
		30=>['avg'=>-1.162790698,'hensa'=>2.614185209,],
		31=>['avg'=>-0.295348837,'hensa'=>0.424786397,],
		32=>['avg'=>-3.093023256,'hensa'=>3.168257929,],
		33=>['avg'=>0.139534884,'hensa'=>1.899588638],
	];



	public function getTime($test){
		$test_id = $test['id'];
		$sql = "
					SELECT 
						minute_rest 
					FROM
						t_test
					WHERE
						type = 85 AND 
						test_id = :test_id
					";
		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':test_id', $test_id, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		return $result;
	}
	public function getTestpaer($where){
		$testgrp_id = $where[ 'testgrp_id' ];
		$exam_id = $where[ 'exam_id' ];
		$type = $where[ 'type' ];
		$sql = "
			SELECT 
				* 
			FROM 
				t_testpaper 
			WHERE 
				testgrp_id = :testgrp_id AND 
				type = :type AND 
				exam_id = :exam_id
			";
		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':testgrp_id', $testgrp_id, PDO::PARAM_INT);
		$stmt->bindValue(':type', $type, PDO::PARAM_INT);
		$stmt->bindValue(':exam_id', $exam_id, PDO::PARAM_STR);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		return $result;
	}

	public function deleteMhq($where){
		$testpaper = $this->getTestpaer($where);
		$testpaper_id = $testpaper[ 'id' ];
		$sql = "DELETE FROM mhq WHERE testpaper_id = :testpaper_id";
		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':testpaper_id', $testpaper_id, PDO::PARAM_INT);
		$stmt->execute();
	}

	public function setData($where){
		$testpaper = $this->getTestpaer($where);
		$update = [];
		foreach($_REQUEST[ 'chk_ans' ] as $key=>$value){
			if(strlen($_REQUEST[ 'ans' ][$key]) > 0 ){
				$update[] = "ans".$key."=".$_REQUEST[ 'ans' ][$key];
			}
		}
		$imp = implode(",",$update);
		$sql = "UPDATE mhq SET 
				".$imp."
			where
				testpaper_id = :testpaper_id
			
		";
		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':testpaper_id', $testpaper[ 'id' ], PDO::PARAM_INT);
		$stmt->execute();

	}

	public function getData($where){
		$testpaper = $this->getTestpaer($where);

		$testpaper_id = $testpaper[ 'id' ];
		$sql = "SELECT * FROM mhq WHERE testpaper_id = :testpaper_id";
		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':testpaper_id', $testpaper_id, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		return $result;
	}

	public function getDataPdf($where){

		$testpaper_id = $where[ 'id' ];
		$sql = "SELECT * FROM mhq WHERE testpaper_id = :testpaper_id";
		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':testpaper_id', $testpaper_id, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		return $result;
	}

	public function setStartTime($where){
		$testpaper = $this->getTestpaer($where);

		$testpaper_id = $testpaper[ 'id' ];
		$sql = "SELECT * FROM mhq WHERE testpaper_id = :testpaper_id";
		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':testpaper_id', $testpaper_id, PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		if($result){

		}else{
			$timesWhere[ 'id' ] = $where[ 'testgrp_id' ];
			$getTime = $this->getTime($timesWhere);
			$timelimit = date("Y-m-d H:i:s",strtotime("+".$getTime[ 'minute_rest' ]." minute"));
			
			$sql = "
				INSERT INTO mhq
					(testpaper_id,
						timelimit
						)
						VALUES
					(:testpaper_id,
						:timelimit
					)";
				$stmt = $this->db->prepare($sql);
				$stmt->bindValue(':testpaper_id', $testpaper_id, PDO::PARAM_INT);
				$stmt->bindValue(':timelimit', $timelimit, PDO::PARAM_STR);
				$stmt->execute();

		}
	}

	public function getTestType($where){
		$sql = "
			SELECT 
				mhq_type 
			FROM 
				t_test 
			WHERE
				test_id = :test_id AND
				type = 85
		";

		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':test_id', $where['testgrp_id'], PDO::PARAM_INT);
		$stmt->execute();
		$result = $stmt->fetch(PDO::FETCH_ASSOC);
		return $result;
	}

	public function setResult($result,$where){
		$data = $this->getData($where);
		$point = [];
		$level = [];
		foreach($result as $key=>$value){
			$point[] = "result".$key."=".$value[ 'point' ];
			$level[] = "level".$key."=".$value[ 'level' ];
		}
		$impPoint = implode(",",$point);
		$impLevel = implode(",",$level);
		$sql = "
			UPDATE mhq SET
				".$impPoint.",
				".$impLevel."
			WHERE
				id=:id
		";

		$stmt = $this->db->prepare($sql);
		$stmt->bindValue(':id', $data[ 'id' ], PDO::PARAM_INT);
		$stmt->execute();
	}

	public function getResult($where){
		$data = $this->getData($where);
		$test = $this->getTestType($where);
		$mhqType = $test[ 'mhq_type' ];

		//step1 反転
		//反転項目が1の項目には-1を掛ける
		//採点除外項目が１の項目には0を掛ける

//var_dump($data,$this->reflect);
		$step1 = [];
		$i=1;
		foreach($this->step1 as $key=>$value){
			$anskey = "ans".$key;
			if($value[ 'reflect' ] === 1){
				$step1[$i] = $data[$anskey]*-1;
			}else
			if($value[ 'erase' ] === 1){
				$step1[$i] = $data[$anskey]*0;
			}else{
				$step1[$i] = $data[$anskey];
			}
			$i++;
		}

		//step2 小カテゴリの素点算出
		//該当する設問の値の合計
		$step2 = [];
		$i=1;
		foreach($this->step2 as $key=>$value){
			$plus = 0;
			foreach($value as $k=>$val){
				$plus += (int)$step1[$val];
			}
			$step2[$i] = $plus;
			$i++;
		}

		//step3 :大中項目の算出
		//中項目：該当する小項目の素点を合計する
		$step3_middle = [];
		$step3_big = [];
		$i=1;
		foreach($this->step3 as $key=>$value){
			$middle = 0;
			foreach($value as $k=>$val){
				$middle += $step2[$val];
			}
			$step3_middle[$i] = $middle; 
			$i++;
		}
		//大項目：中項目の値を設問数で割った値の合計を素点とする			
		$step3_big[1] = $step3_middle[1]/10+$step3_middle[2]/15+$step3_middle[3]/11+$step3_middle[4]/4;
		$step3_big[2] = $step3_middle[5]/19+$step3_middle[6]/12;
		$step3_big[3] = ($step2[22]+$step2[23])/10;

		//step4その他項目の算出
		 $step4[1] = $data['ans29']-$data['ans93'];
		 $step4[2] = $data['ans64']+$data['ans108'];

		 //step5偏差値算出
		$step5[1] = $step3_big[1];
		$step5[2] = $step3_middle[1];
		$step5[3] = $step2[1];
		$step5[4] = $step2[2];
		$step5[5] = $step2[3];
		$step5[6] = $step2[4];
		$step5[7] = $step2[5];
		$step5[8] = $step3_middle[2];
		$step5[9] = $step2[6];	
		$step5[10] = $step2[7];
		$step5[11] = $step3_middle[3];
		$step5[12] = $step2[8];
		$step5[13] = $step2[9];
		$step5[14] = $step3_middle[4];
		$step5[15] = $step2[10];
		$step5[16] = $step2[11];
		$step5[17] = $step2[12];
		$step5[18] = $step2[13];
		$step5[19] = $step2[14];
		$step5[20] = $step2[15];
		$step5[21] = $step3_middle[5];
		$step5[22] = $step2[16];
		$step5[23] = $step3_big[2];
		$step5[24] = $step3_middle[6];
		$step5[25] = $step2[17];
		$step5[26] = $step2[18];
		$step5[27] = $step2[19];
		$step5[28] = $step3_middle[7];
		$step5[29] = $step2[20];
		$step5[30] = $step2[21];
		$step5[31] = $step3_big[3];
		$step5[32] = $step2[22];
		$step5[33] = $step2[23];
		
		if($$mhqType == 2){
			foreach($this->hensa2 as $key=>$value){
				$step5[$key] = (($step5[$key]-$value['avg'])/$value['hensa'])*10+50;
			}
		}else{
			foreach($this->hensa1 as $key=>$value){
				$step5[$key] = (($step5[$key]-$value['avg'])/$value['hensa'])*10+50;
			}
		}

		//step6 偏差値が100以上の場合は、100、0以下の場合は0に補正する
		$step6 = [];
		foreach($step5 as $key=>$value){
			if($value >= 100) $value=100;
			if($value <= 0) $value=0;
			$step6[$key] = $value;
		}

		//step7レベル判定
		// レベル１	３3未満
		// レベル２	３3以上４1未満
		// レベル３	４1以上５8未満
		// レベル４	58以上６６未満
		// レベル５	６６以上
		$step7 = [];
		foreach($step6 as $key=>$value){
			$step7[$key][ 'point' ] = $value;
			$step7[$key][ 'level' ] = $this->setLevel($value);
		}
		return $step7;
	}
	public function setLevel($value){
		$level = 0;
		if($value >= 66) $level = 5;
		if($value < 66 && $value >= 58) $level = 4;
		if($value < 58 && $value >= 41) $level = 3;
		if($value < 41 && $value >= 33) $level = 2;
		if($value < 33) $level = 1;
		return $level;
	}

}


?>